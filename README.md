## Auroradb cluster를 VPC PEERING 해서 사용 할때 발생 할 수 있는 요소.

AWS계정이 하나만 존재한다면 좋겠지만 이런저런 이유로 2개 이상의 계정을 가지고 운영을 하는 곳이 많습니다.

이때 DATABASE는 1이라는 계정에 존재하고 2라는 계정에 어플리케이션이 있다면 어떻게 연결 할까요?

물론 RDS를 퍼블릭하게 만들어서 운영을 할 수있지만 이는 보안적으로 엄청나게 취약하게 되겠죠. 그래서 100% RDS는 프라이빗하게 생성하여 운영합니다. 

(저는 S3, 컨테이너ECS, EC2 전부 프라이빗하게 사용합니다.)

이때 있는 가능이 vpc peering 입니다. 이건 많은 글들이 있으니 여기선 넘어가겠습니다.

Auroradb를 클러스터로 사용한다면 초기에는 보통 마스터, 슬레이브 이렇게 2개를 사용하다 사용자가 많아지면 리더격인 슬레이브를 여러개 생성 할겁니다.

그러나 우리는 어플리케이션 개발시 엔드포인트를 신경 쓰지 않아도 됩니다.

rds에서 알아서 딱 2개의 엔드포인트만 제공합니다.(물론 사용자 엔드포인트 생성이 가능합니다.)

라이터 엔드포인트와, 리더 엔드포인트 입니다.

자 이제 어플리케이션을 만듭니다. 만약 nestjs에 typeorm을 사용한다면 app.module.ts에 아래와 같이 컨넥션 정보를 설정하겠죠.

```javascript
TypeOrmModule.forRoot({
      type: 'mysql',
      logging: true,
      replication: {
        master: {
          host: utill.writer,
          port: 3306,
          username: utill.user,
          password: utill.password,
          database: 'db',
        },
        slaves: [
          {
            host: utill.reader,
            port: 3306,
            username: utill.user,
            password: utill.password,
            database: 'db',
          },
        ],
      },
      entities: [
        path.join(__dirname, '..', '/entities/**/*.entity{.ts,.js}'),
      ],
      keepConnectionAlive: true,
      synchronize: false,
      timezone: 'Asia/Seoul',
    }),
```

그러고 해당 어플리케이션을 ec2 또는 컨테이너 기반인 ecs, eks 에서 실행 할겁니다.

처음에는 문제가 없습니다.

그러다 어느날 갑자기 db 접속이 되지않습니다. 왜 이럴까요?

rds를 바라보니 어라? 라이터 인스턴스가 슬레이브로 되어있고, 리더 인스턴스가 마스터로 되어있습니다.

이유는

어떠한 문제인지 업그레이드인지는 모르겠지만 마스터 인스턴스가 중지 되었고, 이때 rds는 슬레이브 인스턴스를 마스터 인스턴스로 승격 한 것입니다.

그리고 마스터는 슬레이브로 다시 시작이 된것이지요.

같은 aws 계정에 있는 어플리케이션은 아무 문제가없습니다. vpc peering 하여 연결한 계정은 여전히 라이터만 되고 있지않습니다.

이때는 일단 리더(슬레이브)로 만든 인스턴스지만 현재는 마스터(라이터)로 승격한 인스턴스를 클릭하시고 장애조치 를 클릭해줍니다.

그러면 현재 리더(슬레이브)로 되어있는 라이터로 생성한 인스턴스가 다시 마스터로 승격 됩니다.

그리고 마스터로 잠시 승격 되었던 인스턴스는 슬레이브 인스턴스로 다시 시작하게됩니다.

**그럼 왜 이런 문제가 발생할까요? 솔직히 이유는 아직 찾지 못하고 있습니다. 그래서 이런한 글을 올리는 이유이기도합니다.**

저의 검색 실력이 부족해서 일 수 도 있지만 검색을 했지만 이런 케이스에 대한 내용이 있는 문서나 stackoverflow의 글을 찾지 못하였습니다.

#aws 관계자나 또는 아시는 분 있으시며 댓글 달아주세요. 이런 케이스로 맨붕이 온 개발자들좀 같이 보게…